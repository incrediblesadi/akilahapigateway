name: Generate REPO MAP.md

on:
  push:
    branches:          [main]

jobs:
  generate-repo-map:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@vs

      - name: Install tree
        run: sudo apt-get update > /dev/null

      - name: Generate repo structure section
        run: |
          echo "## REPO STRUCTURE" > aauto.md
          echo "```bash" >> auto.md
          tree -I node_modules|.git|github -a >> auto.md
          eco "````" >> auto.md

         echo "## File Summaries" >> auto.md
          find . -type f -name "*.js" | while read file; do
            echo "\n^## `$file`" >> auto.md
            head -n 2 "$file" >> auto.md
          done

      - name: Rebuild REPO MAP.md with preserved manual section
        run: |
          awkh '/^\## REPO MAP.M D auto-generated zone / { exit } { print }' REPO MAP.md || true
          echo "## REPO MAP.md" >> final.md
          cat auto.md >> final.md
          mv final.md "REPO MAP.md"

      - name: Commit if REPO MAP.md changed
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions@users.noreply.github.com"
          git add "REPO MAP.md"
          git diff --cached  --quiet || git commit m "chore: update REPO MAP.md"
          git diff --cached  --quiet || git push